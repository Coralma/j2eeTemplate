angular.module('cccis.angular.common.components.panel').directive("cccisPopupPanel", ['$templateCache', '$timeout', function ($templateCache, $timeout) {
    return {
        restrict: 'E',
        replace: true,
        transclude: true,
        scope: {
            panelCls: '@',
            api: '=',
            direction: '@',//在当前元素上方或下方显示该PopupPanel[above|below]
            align: '@', //与当前元素水平对齐方式[left|center|right]
            arrowFlag: '@', //是否显示箭头标记[true|false]
            offsetY: '@', //弹出框与当前元素的偏差值[number]
            boxShadow: '@' //是否有边框阴影效果
        },
        template: '' +
        '<div class="cccis-popup-panel">' +
        '   <div ng-if="arrowFlag==\'true\' && actualDirection==\'below\'" style="width:100%;font-size: 30px;text-align: center;line-height:0px;margin-top: 0px;position: absolute;color: #a7bac9;">&#9670;</div>' +
        '   <div ng-if="arrowFlag==\'true\' && actualDirection==\'below\'" style="width:100%;font-size: 30px;text-align: center;line-height:0px;margin-top: 2px;position: absolute;color: #edf6fb;">&#9670;</div>' +
        '   <div class="{{panelCls}}" style="width:{{width}};overflow: hidden;" ng-transclude>' +
        '   </div>' +
        '   <div ng-if="arrowFlag==\'true\' && actualDirection==\'above\'" style="width:100%;font-size: 30px;text-align: center;line-height:0px;margin-top: 0px;position: relative;color: #a7bac9;">&#9670;</div>' +
        '   <div ng-if="arrowFlag==\'true\' && actualDirection==\'above\'" style="width:100%;font-size: 30px;text-align: center;line-height:0px;margin-top: -2px;position: relative;color: #edf6fb;">&#9670;</div>' +
        '</div>',
        link: function ($scope, $element, attrs) {
            $scope.onLoad = function () {
                $('body').append($element);

                // init explore api
                $scope.$watch('api', function (newVal, oldVal) {
                    if ($scope.api) {
                        $scope.api.popup = $scope.popup;
                        $scope.api.closeWindow = $scope.closeWindow;
                        $scope.api.setPosition = $scope.setPosition;
                    }
                });
            };

            /**
             * @param inputElement - 默认情况下，在当前控件的左下方展示popup panel
             * @param panelHeight - panel高度，没有填的话，就是自适应高度
             */
            $scope.popup = function (inputElement, panelWidth, panelHeight) {
                $scope.show();
                $scope.setPosition(inputElement, panelWidth, panelHeight);
            };

            $scope.closeWindow = function () {
                $scope.hide();
            };

            /**
             * @param inputElement: 默认基于inputElement的左侧进行popup
             */
            $scope.setPosition = function (inputElement) {
                $scope.setPosition(inputElement, null, null);
            };

            $scope.show = function () {
                $element.show();

                var closeFun = function (e) {
                    var clickInside = $(e.target).closest('popup-panel');
                    if (clickInside.length <= 0) {
                        $scope.hide();
                    } else {
                        $(document).one("click", closeFun);
                    }
                };

                $timeout(function () {
                    $(document).one("click", closeFun);
                }, 500);
            };

            $scope.hide = function () {
                $element.hide();
            };

            $scope.setPosition = function (inputElement, width, height) {
                if (!inputElement) {
                    return;
                }
                // 修复bug15972，overflow的效果等同于overflow-x + overflow-y，操作overflow时不会单独的操作overflow-x和overflow-y
                var bodyOverflowX = $(document.body).css('overflow-x');
                var bodyOverflowY = $(document.body).css('overflow-y');
                $('body').css('overflow', 'hidden');
                $element.css('visibility', 'hidden');

                $timeout(function () {
                    var contentHeight = 0;
                    if (height > 0) {
                        contentHeight = height;
                    } else {
                        //auto height condition, 根据内容自动展开高度
                        contentHeight = $element.find('.popupPanel').height();
                    }

                    var align = $scope.align;
                    if (align != 'center' && align != 'left' && align != 'right') {
                        //默认值-相对位置，与inputElement靠左中右对齐
                        align = 'left';
                    }

                    var x = inputElement.offset().left;
                    var y = inputElement.offset().top + inputElement.height();

                    if (align == 'left') {
                        x = inputElement.offset().left;
                    } else if (align == 'center') {
                        x = inputElement.offset().left + inputElement.outerWidth() / 2 - $element.outerWidth() / 2;
                    } else if (align == 'right') {
                        x = inputElement.offset().left + inputElement.outerWidth() - $element.outerWidth();
                    }

                    var direction = $scope.direction;
                    if (direction != 'above' && direction != 'below') {
                        //默认值-自适应方向的情况
                        if (y + contentHeight + 5 > $(window).height()) {
                            direction = 'above';
                        } else {
                            direction = 'below';
                        }
                    }
                    $scope.actualDirection = direction;

                    if (direction == 'above') {
                        //show dialog above
                        y = inputElement.offset().top - contentHeight - ($scope.offsetY ? parseInt($scope.offsetY) : 0);
                        if ($scope.boxShadow == 'true') {
                            $element.find('.popupPanel').css('box-shadow', '3px -3px 2px gray');
                        }
                    } else if (direction == 'below') {
                        //show dialog below
                        y = inputElement.offset().top + inputElement.height() + 5 + ($scope.offsetY ? parseInt($scope.offsetY) : 0);
                        if ($scope.boxShadow == 'true') {
                            $element.find('.popupPanel').css('box-shadow', '3px 3px 2px gray');
                        }
                    }
                    $element.css({'left': x + 'px', 'top': y + 'px'});

                    //auto height condition, 根据内容自动展开高度
                    if (height) {
                        $($element.children()[0]).css('height', height + 'px');
                    }

                    //auto condition, 根据内容自动展开宽度
                    if (width) {
                        $($element.children()[0]).css('width', (width + 2) + 'px'); //加上内部左右边框的距离
                    }

                    $element.css('visibility', 'visible');
                    $(document.body).css({'overflow-x': bodyOverflowX, 'overflow-y': bodyOverflowY});
                });
            };

            $scope.onLoad();
        }
    };
}]);