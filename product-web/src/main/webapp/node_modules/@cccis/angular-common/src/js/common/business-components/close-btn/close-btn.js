'use strict';
/**
 * CloseBtn: 用于form表单验证的场景，提供关闭按钮后的用户变更验证
 */
angular.module('cccis.angular.common.business-components.closeBtn').directive('cccisCloseBtn', ['$q', 'cccisCommonDialogProvider',
    function ($q, cccisCommonDialogProvider) {
        return {
            restrict: 'E',
            transclude: true,
            replace: true,
            require: '^form',
            scope: {
                ngId: '@',//input id值
                caption: '@', //按钮文本
                dirtyFormCheck: '@', //是否需要做脏表单检查
                confirmMessage: '@', //自定义提示消息
                onCloseBtnClick: '=' //触发的逻辑
            },
            template: '' +
            '<input type="button" class="btn btn-primary" value="{{caption}}" ng-click="onBtnClicked()">' +
            '</input>',
            link: function ($scope, $element, $attrs, $ngModelCtrl) {
                $scope.onLoad = function () {
                    $scope.caption = $scope.caption || '关 闭';
                    $scope.dirtyFormCheck = $scope.dirtyFormCheck || 'true';
                    $scope.confirmMsg = $scope.confirmMsg || '您有未保存数据，确认离开此页面？';
                };

                $scope.onBtnClicked = function () {
                    var deferred = $q.defer();
                    if ($scope.dirtyFormCheck == 'true' && $ngModelCtrl.$dirty) {
                        cccisCommonDialogProvider.confirm($scope.confirmMsg).then(function (result) {
                            if (result == true) {
                                deferred.resolve(true);
                            } else {
                                deferred.resolve(false);
                            }
                        });
                    } else {
                        deferred.resolve(true);
                    }

                    deferred.promise.then(function(result){
                        if(result == true){
                            $scope.onCloseBtnClick();
                        }
                    });
                };

                $scope.onLoad();
            }
        }
    }])
;