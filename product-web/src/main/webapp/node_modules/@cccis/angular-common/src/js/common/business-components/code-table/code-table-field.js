'use strict';
angular.module('cccis.angular.common.businessComponents.codeTable').directive('cccisCodeTableField', ['cccisCodeTableUtils', function (cccisCodeTableUtils) {
    return {
        require: 'ngModel',
        restrict: 'E',
        replace: false,
        scope: {
            ngModel: '=',           //codeId
            searchTitle: '@',
            codeTypeId: '@',
            hasEmptyOptionFlag: '@',//是否有空行（查询界面使用）
            emptyOptionText: '@',//空行对应的文本
            beforeOptionSelected: '=',//选中option之前触发
            onAfterOptionSelected: '=',//选中option之后触发
        },
        link: function ($scope, $element, $attrs, ngModelCtrl) {

            $scope.onLoad = function () {
                if ($scope.codeTypeId) {
                    var codes = cccisCodeTableUtils.getCodesByType($scope.codeTypeId);
                    codes = _.sortBy(codes, ['codeId']);
                    if ($scope.hasEmptyOptionFlag == 'true') {
                        codes.unshift({codeId: null, text: $scope.emptyOptionText || $scope.searchTitle || ''});
                    }
                    $scope.codes = codes;

                    $scope.$watch('ngModel', function(){
                        var found = _.find($scope.codes, {codeId: $scope.ngModel});
                        $scope.codeModel = found;
                    });

                    $scope.$watch('codeModel', function(){
                        $scope.ngModel = $scope.codeModel?$scope.codeModel.codeId:null;
                    });
                }
            };

            $scope.onLoad();
        },
        template: '' +
        '<dropdown-field ng-model="codeModel" search-title="{{searchTitle}}" search-enabled="false" option-list="codes" option-value="codeId" option-text="text">' +
        '</dropdown-field>'
    }
}]);