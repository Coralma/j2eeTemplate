angular.module('cccis.angular.common.utils').factory('cccisLocalAreaUtils', ['$q', 'cccisUrlUtils', function ($q, cccisUrlUtils) {
    var KEY_LOCAL_AREA_TREE = 'KEY_LOCAL_AREA_TREE';
    /**
     * 从服务端重新获取localAreaMap
     */
    var fetchLocalAreaMap = function () {
        var deferred = $q.defer();

        cccisUrlUtils.postJsonData("/base/localArea/listAll", {}).then(function (data) {
            if (data.result != cccisUrlUtils.RESULT.SUCCESS) {
                console.log(data.message);
                deferred.resolve(null);
            } else {
                deferred.resolve(data.localAreaMap);
            }

        });
        return deferred.promise;
    };

    var initLocalAreaTree = function () {
        var deferred = $q.defer();
        var localAreaTree = localStorage.getItem(KEY_LOCAL_AREA_TREE);
        if (localAreaTree) {
            deferred.resolve(true);
        } else {
            fetchLocalAreaMap().then(function (localAreaMap) {
                if (localAreaMap) {
                    localStorage.setItem(KEY_LOCAL_AREA_TREE, Base64.encode(JSON.stringify(localAreaMap)));
                    deferred.resolve(true);
                } else {
                    deferred.resolve(false);
                }
            })
        }
        return deferred.promise;
    };

    /**
     * 取得全国行政树
     */
    var getLocalAreaMap = function () {
        var localAreaTreeJSON = localStorage.getItem(KEY_LOCAL_AREA_TREE);
        if (localAreaTreeJSON) {
            return JSON.parse(Base64.decode(localAreaTreeJSON));
        } else {
            return null;
        }
    };

    var getLocalAreaByAreaId = function(areaId){
        var map = getLocalAreaMap();
        if(map){
           return map[areaId];
        }else{
            return null;
        }
    };

    /**
     * 根据addressType， build地址字符串
     */
    var buildWholeLocalAddress = function(addressType){
        if(addressType==null){
            return '';
        }

        var addressArray = [];
        if(addressType.provinceId){
            var province = getLocalAreaByAreaId(addressType.provinceId);
            if(province){
                addressArray.push(province.areaName);
            }
        }
        if(addressType.cityId){
            var city = getLocalAreaByAreaId(addressType.cityId);
            if(city){
                addressArray.push(city.areaName);
            }
        }
        if(addressType.distinctId){
            var distinct = getLocalAreaByAreaId(addressType.distinctId);
            if(distinct){
                addressArray.push(distinct.areaName);
            }
        }
        if(addressType.address){
            addressArray.push(addressType.address);
        }
        return addressArray.join('');
    };

    return {
        initLocalAreaTree: initLocalAreaTree,
        getLocalAreaTree: getLocalAreaMap,
        getLocalAreaByAreaId: getLocalAreaByAreaId,
        buildWholeLocalAddress: buildWholeLocalAddress
    };
}]);