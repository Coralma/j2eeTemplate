'use strict';
angular.module('cccis.angular.common.components.inputField')
    .directive("radioGroupField", ['$timeout', function ($timeout) {
        return {
            restrict: 'E',
            replace: true,
            scope: {
                group: '@',
                ngModel: '=',
                optionList: '=',
                optionText: '@',    //option的对象显示的TEXT文本属性
                optionValue: '@',   //option的对象对应的VALUE属性
                onItemChanged: '=',
                disabled: '@',
                uncheckable: '@', //是否支持反选
                radioGroupFieldClass: '@'
            },
            template: '' +
            '<div class="cccis-radio-group-field {{radioGroupFieldClass}}">' +
            '   <div ng-repeat="option in optionList" ng-click="onRadioClick(option)" class="option" title="{{option[optionText]}}">' +
            '       <input type="radio" name="{{group}}" ng-model="$parent.ngModel" ng-value="option[optionValue]"/>' +
            '       <div class="icon" ng-class="{' +
            '           \'radio-normal-unchecked-icon\' : (ngModel!=option[optionValue] && disabled!=\'true\'), ' +
            '           \'radio-normal-checked-icon\': (ngModel==option[optionValue] && disabled!=\'true\'),' +
            '           \'radio-disabled-checked-icon\': (ngModel!=option[optionValue] && disabled==\'true\'),' +
            '           \'radio-disabled-unchecked-icon\': (ngModel==option[optionValue] && disabled==\'true\') ' +
            '           }"></div>' +
            '       <div class="caption">{{option[optionText]}}</div>' +
            '   </div>'+
            '</div>',
            link: function ($scope, $elem, attrs) {
                //Options
                $scope.group = $scope.group || _.uniqueId('radio-group-');

                //public method
                $scope.onRadioClick = function (option) {
                    if($scope.uncheckable == 'true'){
                        if($scope.ngModel == option[$scope.optionValue]){
                            $scope.ngModel = null;
                        }else{
                            $scope.ngModel = option[$scope.optionValue];
                        }
                    }else{
                        $scope.ngModel = option[$scope.optionValue];
                    }

                    if($scope.onItemChanged){
                        $timeout(function(){
                            $scope.onItemChanged($scope.ngModel);
                        });
                    }

                    //触发onChange事件
                    var event = document.createEvent('HTMLEvents');
                    event.initEvent("change", true, true);
                    event.eventType = 'message';
                    if( $elem[0].dispatchEvent) {
                        return  $elem[0].dispatchEvent(event);
                    } else if( $elem[0].fireEvent) {
                        return  $elem[0].fireEvent("onchange", event);
                    }
                };
            }

    };
    }]);