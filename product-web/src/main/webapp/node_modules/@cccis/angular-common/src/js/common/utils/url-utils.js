angular.module('cccis.angular.common.utils').factory('cccisUrlUtils', ['$location', 'Restangular', '$window', '$q', function ($location, Restangular, $window, $q) {
    var postPath;
    var dialogProvider;
    //网络请求返回状态
    var RESULT = {
        SUCCESS: 'success',
            FAILURE: 'failure'
    };


    return {
        setAppErrorDialogProvider: setAppErrorDialogProvider,
        getPath: getPath,
        postJsonData: postJsonData,
        postFormData: postFormData,
        getJsonData: getJsonData,
        getFormData: getFormData,
        RESULT: RESULT
    };

    function setAppErrorDialogProvider(appErrorDialogProvider) {
        dialogProvider = appErrorDialogProvider;
    }

    function getPath(path) {
        if (angular.isUndefined(postPath)) {
            var strPath = $window.document.location.pathname;
            postPath = strPath.substring(0, strPath.substr(1).indexOf('/') + 1);
        }
        return postPath + path;
    }

    /**
     * 提交json数据
     */
    function postJsonData(url, jsonObj, silentFlag) {
        var deferred = $q.defer();
        Restangular.all(this.getPath(url)).post(jsonObj, {}, {'Content-Type': 'application/json; charset=UTF-8'}).then(
            function (result) {
                dataErrorHandler(result, silentFlag);
                deferred.resolve(result);
            }, function (result) {
                httpErrorHandler(result, silentFlag);
            });
        return deferred.promise;
    }

    /**
     * 提交json数据
     */
    function getJsonData(url, jsonObj, silentFlag) {
        var deferred = $q.defer();
        Restangular.all(this.getPath(url)).get(jsonObj, {}, {'Content-Type': 'application/json; charset=UTF-8'}).then(
            function (result) {
                dataErrorHandler(result, silentFlag);
                deferred.resolve(result);
            }, function (result) {
                httpErrorHandler(result, silentFlag);
            });
        return deferred.promise;
    }

    /**
     * 提交Form数据
     */
    function postFormData(url, jsonObj, silentFlag) {
        var deferred = $q.defer();
        var params = getUrlParam(jsonObj);
        Restangular.all(this.getPath(url)).post(params, {}, {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}).then(
            function (result) {
                dataErrorHandler(result, silentFlag);
                deferred.resolve(result);
            }, function (result) {
                httpErrorHandler(result, silentFlag);
            });
        return deferred.promise;
    }

    /**
     * 提交Form数据
     */
    function getFormData(url, jsonObj, silentFlag) {
        var deferred = $q.defer();
        var params = getUrlParam(jsonObj);
        Restangular.all(this.getPath(url)).get(params, {}, {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}).then(
            function (result) {
                dataErrorHandler(result, silentFlag);
                deferred.resolve(result);
            }, function (result) {
                httpErrorHandler(result, silentFlag);
            });
        return deferred.promise;
    }

    function getUrlParam(params) {
        var param = '';
        _.each(params, function (i, val) {
            param += val + '=' + i + '&';
        });
        if (param) {
            param = param.substring(0, param.length - 1);
        }
        return param;
    }

    /**
     * 系统处理出错的情况
     */
    function dataErrorHandler(data, silentFlag) {
        if (data.result == RESULT.SUCCESS) {
            return;
        }
        if(data.result==null && Object.prototype.toString.call(data) === "[object String]" && data.indexOf('partsApp')>0){
            //100%是因为session失效
            if(!silentFlag && dialogProvider) {
                dialogProvider.showAppErrorDialog("您的操作已超时，系统将自动退出。").then(function($dialogScope){
                    $dialogScope.onDialogClose = function(){
                        window.location.href = getPath('');
                    }
                });
            }
        }
        //需要处理的系统异常情况
        if (data.result == RESULT.FAILURE) {
            if (data.code == '1') {
                //您操作的订单不是最新数据，请重新打开订单后再修改。
                if(!silentFlag && dialogProvider) {
                    dialogProvider.showAppErrorDialog(data.message);
                }
            }else if (data.code == '2') {
                //您没有权限查看订单。
                if(!silentFlag && dialogProvider) {
                    dialogProvider.showAppErrorDialog(data.message);
                }
            } else {
                var message=data&&data.message?data.message:data;
                console.error("http error:"+message);
                if(!silentFlag && dialogProvider) {
                    dialogProvider.showAppErrorDialog(message);
                }
            }
        }
    };

    /**
     * 网络等无法handle的系统异常情况(SpringMVC对异常的封装)
     */
    function httpErrorHandler(data, silentFlag) {
        if (data.status == 500) {
            if(!silentFlag && dialogProvider){
                dialogProvider.showAppErrorDialog("服务器异常。");
            }
            console.log(data.statusText);
        } else {
            console.error(data.statusText);
        }
    }
}]);